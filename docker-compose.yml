version: '2.4'

services:

  webhook:
    extends:
      file: cicd/docker-webhook/docker-compose.yml
      service: docker-webhook

  jenkins-dind:
    extends:
      file: cicd/jenkins-dind/docker-compose.yml
      service: jenkins-dind

  jenkins:
    extends:
      file: cicd/jenkins/docker-compose.yml
      service: jenkins
    depends_on:
      jenkins-dind:
        condition: service_healthy

  loki:
    extends:
      file: logging/loki/docker-compose.yml
      service: loki
    depends_on:
      minio:
        condition: service_healthy

  promtail:
    extends:
      file: logging/promtail/docker-compose.yml
      service: promtail
    depends_on:
      loki:
        condition: service_healthy

  minio:
    extends:
      file: logging/minio/docker-compose.yml
      service: minio

  mc:
    extends:
      file: logging/mc/docker-compose.yml
      service: mc
    depends_on:
      minio:
        condition: service_healthy

  grafana:
    extends:
      file: logging/grafana/docker-compose.yml
      service: grafana
    depends_on:
      loki:
        condition: service_healthy
      promtail:
        condition: service_started
  
  make-backup:
    extends:
      file: backup/make-backup/docker-compose.yml
      service: make-backup
    depends_on:
      minio:
        condition: service_healthy
      mc:
        condition: service_started

  test:
    extends:
      file: test/docker-compose.yml
      service: test

  restore-backup:
    extends:
      file: backup/restore-backup/docker-compose.yml
      service: restore-backup
    depends_on:
      mc:
        condition: service_started

  portainer:
    extends:
      file: portainer/docker-compose.yml
      service: portainer

volumes:
  backup-data:
  jenkins-certs:
  jenkins-data:
  minio-data:
  minio-mirror-data:
  java-discord-help-bot-volume-db:
  br:
  mc-data:
  tv:
  jenkins-dind-volumes:
  portainer_data:

networks:
  jenkins:
  loki-network:
